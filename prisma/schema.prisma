generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum StaffRole {
  admin
  administration
  collection
  processing
  quality_control
  storage
}

enum BirthStatus {
  planned
  contacted
  delivered
  cancelled
}

model Type{
  id    String   @id @default(uuid())
  name  String?
  contracts Contract[]
}

model Staff {
  id        String   @id @default(uuid())
  fullName  String
  phone     String?
  email     String @unique

  role      StaffRole
  isActive  Boolean @default(true)
  password String

  createdAt DateTime @default(now())
  consultings Consulting[]
  samplesCollected Sample[]
  processings SampleProcessing[]
  qualityControls QualityControl[]
  birthFollowUps BirthFollowUp[]
}

model ChannelMarketing{
  id        String   @id @default(uuid())
  name      String 
  customers Customer[]
}

model Customer {
  id        String   @id @default(uuid())
  fullName  String
  phone     String
  email     String?
  address   String?
  consulting Consulting[]
  channelMarketing ChannelMarketing? @relation(fields: [channelMarketingId], references: [id], onDelete: SetNull)
  channelMarketingId String?
  dateOfBirth  DateTime?
  edd          DateTime?
  contract    Contract[]

  births    BirthTracking[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Consulting {
  id        String   @id @default(uuid())
  customer  Customer @relation(fields: [customerId], references: [id])
  customerId String
  Content   String?

  staff   Staff @relation(fields:[staffid], references: [id])
  staffid String
  createdAt DateTime @default(now())
}


model Contract {
  id        String   @id @default(uuid())
  customer  Customer @relation(fields: [customerId], references: [id])
  customerId String
  no         String? @unique
  type       Type @relation(fields: [typeId], references: [id])
  typeId     String
  dateContract DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BirthTracking {
  id        String   @id @default(uuid())
  customer  Customer @relation(fields: [customerId], references: [id])
  customerId String

  edd               DateTime?
  actualBirthAt DateTime?

  hospitalName      String?
  hospitalAddress   String?

  birthType         String?
  babiesCount       Int      @default(1)

  status            BirthStatus
  note              String?

  samples           Sample[]
  followUps         BirthFollowUp[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BirthFollowUp {
  id        String   @id @default(uuid())
  birth     BirthTracking @relation(fields: [birthId], references: [id])
  birthId  String

  followType String
  plannedDate DateTime?
  contactedAt DateTime?
  staff Staff @relation(fields:[staffId], references: [id])
  staffId String
  note    String?
}

model Sample {
  id        String   @id @default(uuid())
  birth     BirthTracking @relation(fields: [birthId], references: [id])
  birthId  String

  babyOrder Int
  collectedBy Staff @relation(fields: [staffId], references: [id])
  staffId String
  collectedAt DateTime?
  condition String?

  processing SampleProcessing[]     // 1 Sample có nhiều Processings
  externalTests ExternalTest[]      // 1 Sample có nhiều ExternalTests
  qualityControl QualityControl[]   // 1 Sample có nhiều QC
  storage Storage[]                 // 1 Sample có thể được lưu nhiều lần

  createdAt DateTime @default(now())
  @@index([birthId])
}

model SampleProcessing {
  id        String   @id @default(uuid())
  sample    Sample   @relation(fields: [sampleId], references: [id])
  sampleId  String

  processedBy Staff @relation(fields: [staffId], references: [id])
  staffId String
  processedAt DateTime?
  note String?
}

model ExternalTest {
  id        String   @id @default(uuid())
  sample    Sample   @relation(fields: [sampleId], references: [id])
  sampleId String

  labName String
  sentAt DateTime?
  resultReceivedAt DateTime?
  resultStatus String
  note String?
}

model QualityControl {
  id        String   @id @default(uuid())
  sample    Sample   @relation(fields: [sampleId], references: [id])
  sampleId String

  qcStaff Staff @relation(fields: [staffId], references: [id])
  staffId String
  checkedAt DateTime?
  result ResultQualityControl[]
  note String?
}

model ResultQualityControl{
  id  String   @id @default(uuid())
  qualityControl QualityControl   @relation(fields: [qcId], references: [id])
  qcId String
  status String
}

model StorageTank {
  id        String   @id @default(uuid())
  tankCode  String   @unique
  description String?
  location String?
  storages Storage[]
}

model Storage {
  id        String   @id @default(uuid())
  sample    Sample   @relation(fields: [sampleId], references: [id])
  sampleId String

  tank     StorageTank @relation(fields: [tankId], references: [id])
  tankId  String

  storedAt DateTime?
  removedAt DateTime?
  status String
}
